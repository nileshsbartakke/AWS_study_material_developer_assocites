function AxiomMessageManager(iStartTime,oPlayer,fnMessageCall,bLive){this.m_iStartTime=iStartTime&&iStartTime>0?iStartTime:0,this.m_fnMessageCall=fnMessageCall,this.m_iMediaOffset=0,this.m_bLive=bLive,this.m_aSeekableMessages=[],this.m_aLingeringMessages=[],this.m_aMessageCue=[],this.m_oCurrentMessage=null,this.m_iMessageTimeout=0,this.m_iCurrentIndex=-1,this.m_iCurrentSeekableIndex=-1,this.m_bPaused=!0,this.m_bPendingStop=!1,this.m_bMediaCompleted=!1,this.m_oSlideAnimationMessageKey=null,this.m_bReady=!1,oPlayer&&this.SetMediaPlayer(oPlayer)}AxiomMessageManager.prototype.SetMediaPlayer=function(oPlayer){this.m_oPlayer=oPlayer,this.m_oPlayer&&(this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_METADATA_LOADED,this._onPlayerMetadataLoaded.bind(this)),this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_DATA_LOADED,this._onPlayerDataLoaded.bind(this)),this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_PLAY,this._onPlayerPlay.bind(this)),this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_PAUSE,this._onPlayerPause.bind(this)),this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_SEEKING,this._onPlayerSeeking.bind(this)),this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_SEEKED,this._onPlayerSeeked.bind(this)),this.m_oPlayer.setHandler(AXIOM_MEDIA_PLAYER_COMPLETE,this._onPlayerComplete.bind(this))),this._NextMessage()},AxiomMessageManager.prototype.SetStartTime=function(iStartTime){this.m_iStartTime=iStartTime&&iStartTime>0?iStartTime:0,this._NextMessage()},AxiomMessageManager.prototype.SetMediaOffset=function(iOffset){this.m_iMediaOffset=iOffset&&!isNaN(iOffset)?iOffset:0,this._NextMessage()},AxiomMessageManager.prototype.SetMessageCallBack=function(fnMessageCall){fnMessageCall&&(this.m_fnMessageCall=fnMessageCall)},AxiomMessageManager.prototype.GetStartTime=function(){return this.m_iStartTime},AxiomMessageManager.prototype.GetCurrentTime=function(){var iTime=0;return this.m_oPlayer&&(iTime=this.m_oPlayer.getCurrentTime()),this.m_iStartTime>0&&(iTime+=this.m_iStartTime),iTime},AxiomMessageManager.prototype.GetTime=function(){var iTime=0;return this.m_oPlayer&&this.m_iStartTime>0&&(iTime=this.m_oPlayer.getCurrentTime()+(this.m_oPlayer.bWebRTC?this.m_iMediaOffset:0)),iTime},AxiomMessageManager.prototype.CanSeekByDirection=function(iDirection){var iIndex=this.GetCurrentIndex();return-1==iDirection?iIndex>0:1==iDirection&&iIndex<this.GetMessageCount()},AxiomMessageManager.prototype.GetMessageCount=function(){return this.m_aSeekableMessages.length-1},AxiomMessageManager.prototype.GetCurrentIndex=function(){return this.m_iCurrentSeekableIndex},AxiomMessageManager.prototype.GetMessageByIndex=function(iIndex){return this.m_aSeekableMessages[iIndex]},AxiomMessageManager.prototype.GetMessageByDirection=function(iDirection){var iIndex=this.GetCurrentIndex()+iDirection;return iIndex<0&&(iIndex=0),iIndex>=this.GetMessageCount()&&(iIndex=this.GetMessageCount()),this.m_aSeekableMessages[iIndex]},AxiomMessageManager.prototype.GetSeekTimeByDirection=function(iDirection){var oMessage=this.GetMessageByDirection(iDirection),iTime=this.GetStartTime();return oMessage.Time-iTime},AxiomMessageManager.prototype.GetMessageIndexByTime=function(iTime){var iSearchIndex=this.m_iCurrentSeekableIndex;iSearchIndex<0&&(iSearchIndex=Math.floor(this.m_aSeekableMessages.length/2));var iDiff=this.m_aSeekableMessages[iSearchIndex].Time-(this.m_iStartTime+iTime),iIndex=iSearchIndex;return iDiff>0?iIndex=this._SearchByTime(iTime,0,iSearchIndex):iDiff<0&&(iIndex=this._SearchByTime(iTime,iSearchIndex,this.m_aSeekableMessages.length-1)),iSearchIndex=iIndex},AxiomMessageManager.prototype.GoToMessageByIndex=function(iIndex){this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0;var bChangeDirection=!1;iIndex<this.m_iCurrentSeekableIndex&&iIndex==this.m_iCurrentSeekableIndex-1&&(bChangeDirection=!0);this.m_iCurrentSeekableIndex;this.m_iCurrentSeekableIndex=iIndex;var aLingeringMessages=this.m_aLingeringMessages;this.m_aLingeringMessages=[];for(var oMSG,iMessageIndex=0,iSeekIndex=-1,aSeekableMessages=this.m_aSeekableMessages[this.m_iCurrentSeekableIndex].Messages,iLup=0;iLup<aSeekableMessages.length;iLup++)iSeekIndex<(iMessageIndex=aSeekableMessages[iLup].Index)&&(iSeekIndex=iMessageIndex),-1==iMessageIndex&&"ScreenShareUnPublish"==aSeekableMessages[iLup].Type?((oMSG={})[MSG_ATTR_TIMESTAMP_TAG]=0,oMSG[MSG_ATTR_MESSAGE_DATA]={},oMSG[MSG_ATTR_MESSAGE_DATA][MSG_ATTR_SCREEN_SHARE_STREAM_ID]="null",oMSG[MSG_ATTR_MESSAGE_DATA][MSG_ATTR_SCREEN_SHARE_STREAM_ID]=0,oMSG[MSG_ATTR_MESSAGE_DATA][MSG_ATTR_SCREEN_SHARE_INPUT_KEY]=null,oMessage=new AxiomScreenShareUnPublish(oMSG)):oMessage=this.m_aMessageCue[iMessageIndex],bChangeDirection&&oMessage instanceof AxiomSlideAnimation&&(oMessage=CopySlideAnimation(oMessage),oMessage.Direction=-1*oMessage.Direction),oMessage instanceof AxiomScreenSharePublish&&this.RemoveAssociatedMessage(oMessage,aLingeringMessages),iLup==aSeekableMessages.length-1?(this.m_iCurrentIndex=iSeekIndex,this.m_oCurrentMessage=oMessage,this._ExecuteMessage()):this._MessageCall(oMessage);this.ClearOutMessages(aLingeringMessages)},AxiomMessageManager.prototype.GoToMessageByTime=function(iTime){if(this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_aMessageCue&&0!=this.m_aMessageCue.length&&this.m_aSeekableMessages&&0!=this.m_aSeekableMessages.length){var iIndex=this.GetMessageIndexByTime(iTime);this.GoToMessageByIndex(iIndex)}},AxiomMessageManager.prototype.GoToNextMessage=function(){this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0,this.m_iCurrentIndex++,this.m_oCurrentMessage=this.m_aMessageCue[this.m_iCurrentIndex],this._ExecuteMessage()},AxiomMessageManager.prototype.GoToPreviousMessage=function(){this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0,this.m_iCurrentIndex--,this.m_oCurrentMessage=this.m_aMessageCue[this.m_iCurrentIndex],this._ExecuteMessage()},AxiomMessageManager.prototype.AddMessage=function(oMSG){if(this.m_bPendingStop||(this.m_bPendingStop=oMSG instanceof AxiomStop),!this.m_bLive&&oMSG.MessageType){var iDuration=this.m_oPlayer.getDuration(),oLastMessage=null;if(this.m_aMessageCue&&this.m_aMessageCue.length>0&&(oLastMessage=this.m_aMessageCue[this.m_aMessageCue.length-1]),oMSG instanceof AxiomScreenShareReady&&oLastMessage instanceof AxiomScreenShareReady&&oMSG.M3U8==oLastMessage.M3U8&&oMSG.MPD==oLastMessage.MPD&&(oMSG=null),oMSG){oMSG instanceof AxiomSlideAnimation&&(this.m_oSlideAnimationMessage&&this.m_oSlideAnimationMessage.Key==oMSG.Key&&(oMSG.AnimationCount=this.m_oSlideAnimationMessage.AnimationCount+oMSG.Direction),this.m_oSlideAnimationMessage=oMSG);var oScreenSharePublish=null,bScreenShareUnPublish=!1,oMessage={Time:0,Messages:[]},aMessages=[],aUpdateMessages=[];if(this.m_aSeekableMessages.length>0){var iLup=0;for(aMessages=this.m_aSeekableMessages[this.m_aSeekableMessages.length-1].Messages;iLup<aMessages.length;iLup++)-1==oMSG.ClearMessages.indexOf(aMessages[iLup].Type)&&oMSG.MessageType!=aMessages[iLup].Type&&("ScreenShareReady"==aMessages[iLup].Type?!0:"ScreenShareUnPublish"==aMessages[iLup].Type&&(bScreenShareUnPublish=!0),aUpdateMessages.push({Type:aMessages[iLup].Type,Index:aMessages[iLup].Index}))}oMSG instanceof AxiomScreenSharePublish?oScreenSharePublish=oMSG:oMSG instanceof AxiomScreenShareReady?(oScreenSharePublish&&(oMSG.Time=oScreenSharePublish.Time),!0):oMSG instanceof AxiomScreenShareUnPublish&&(oScreenSharePublish=null,bScreenShareUnPublish=!0),!bScreenShareUnPublish&&oScreenSharePublish&&aUpdateMessages.push({Type:"ScreenShareUnPublish",Index:-1}),aUpdateMessages.push({Type:oMSG.MessageType,Index:this.m_aMessageCue.length}),oMessage.Time=oMSG.Time,oMessage.Messages=aUpdateMessages,iDuration>oMSG.Time-this.GetStartTime()&&(this.m_aSeekableMessages.push(oMessage),oMSG.SeekableIndex=this.m_aSeekableMessages.length-1)}}oMSG&&this.m_aMessageCue.push(oMSG),this._NextMessage()},AxiomMessageManager.prototype.RemoveAssociatedMessage=function(oMessage,aMessages){for(var iLup=0;iLup<aMessages.length;iLup++)aMessages[iLup]instanceof AxiomScreenSharePublish&&oMessage[MSG_ATTR_SCREEN_SHARE_STREAM_ID]==aMessages[iLup][MSG_ATTR_SCREEN_SHARE_STREAM_ID]&&(aMessages.splice(iLup,1),iLup--)},AxiomMessageManager.prototype.ClearOutMessages=function(aMessages){for(var oMSG,oMessage,iLup=0;iLup<aMessages.length;iLup++)aMessages[iLup]instanceof AxiomScreenSharePublish&&((oMSG={})[MSG_ATTR_TIMESTAMP_TAG]=0,oMSG[MSG_ATTR_MESSAGE_DATA]={},oMSG[MSG_ATTR_MESSAGE_DATA][MSG_ATTR_SCREEN_SHARE_STREAM_ID]=aMessages[iLup][MSG_ATTR_SCREEN_SHARE_STREAM_ID],oMSG[MSG_ATTR_MESSAGE_DATA][MSG_ATTR_SCREEN_SHARE_INPUT_KEY]=aMessages[iLup][MSG_ATTR_SCREEN_SHARE_INPUT_KEY],oMessage=new AxiomScreenShareUnPublish(oMSG),this._MessageCall(oMessage))},AxiomMessageManager.prototype.Pause=function(){this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0,this.m_bPaused=!0},AxiomMessageManager.prototype.Resume=function(bDisableSkip){this.m_bPaused=!1,this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0,this.m_bLive?this.m_oCurrentMessage?this._ExecuteMessage():(bDisableSkip||this.SkipToTime(this.GetTime()),this.m_iCurrentIndex,this._NextMessage()):(this.m_iCurrentIndex--,this._NextMessage())},AxiomMessageManager.prototype.SkipToTime=function(iTargetTime){for(var oMessage,aScreenShareMessages=[],aSlideMessages=[],aPollMessages=[],iLup=0;iLup<this.m_aMessageCue.length&&(oMessage=this.m_aMessageCue[iLup]).Time-this.m_iStartTime<iTargetTime;iLup++)oMessage instanceof AxiomSlide?aSlideMessages=[oMessage]:oMessage instanceof AxiomSlideAnimation?aSlideMessages.push(oMessage):oMessage instanceof AxiomPoll?aPollMessages=[oMessage]:oMessage instanceof AxiomScreenShareReady||oMessage instanceof AxiomScreenShareSegment||oMessage instanceof AxiomScreenSharePublish?aScreenShareMessages.push(oMessage):oMessage instanceof AxiomScreenShareUnPublish&&(aScreenShareMessages=[]);this.m_aMessageCue.splice(0,iLup),this.m_aMessageCue=aSlideMessages.concat(aPollMessages,aScreenShareMessages,this.m_aMessageCue)},AxiomMessageManager.prototype.Reset=function(){this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0,this.m_iCurrentIndex=-1,this.m_iCurrentSeekableIndex=-1,this.m_oCurrentMessage=null,this.m_bPendingStop=!1,this.m_bLive?this.m_aMessageCue=[]:this.Pause()},AxiomMessageManager.prototype._SearchByTime=function(iTime,iStartIndex,iEndIndex){var iIndex=iStartIndex+Math.floor((iEndIndex-iStartIndex)/2);if(iIndex==iStartIndex)return iStartIndex;var iDiff=this.m_aSeekableMessages[iIndex].Time-(this.m_iStartTime+iTime);return iDiff>0?this._SearchByTime(iTime,iStartIndex,iIndex):iDiff<0?this._SearchByTime(iTime,iIndex,iEndIndex):iIndex},AxiomMessageManager.prototype._SearchSlideMessageFromTime=function(){if(this.m_aMessageCue.length>0){var iLup=0;for(iLup=0;iLup<this.m_aMessageCue.length;iLup++)this.m_aMessageCue[iLup]}return-1},AxiomMessageManager.prototype._NextMessage=function(){if(!this.m_bPaused){this.m_bReady||(this.m_bReady=!0);var iNext,oNext,bMessageReady=!1;if(this.m_iCurrentIndex<-1&&(this.m_iCurrentIndex=-1),this.m_bLive)!this.m_aMessageCue||this.m_aMessageCue.length,this.m_aMessageCue&&this.m_aMessageCue.length>0&&0==this.m_iMessageTimeout&&(this.m_oCurrentMessage=this.m_aMessageCue.shift(),bMessageReady=!0);else this.m_aMessageCue&&this.m_iCurrentIndex<this.m_aMessageCue.length&&this.m_aMessageCue.length>0&&0==this.m_iMessageTimeout&&(iNext=this.m_iCurrentIndex+1,(oNext=this.m_aMessageCue[iNext])&&oNext.Time&&(this.m_iCurrentIndex=iNext,this.m_oCurrentMessage=oNext,bMessageReady=!0));bMessageReady&&this._ExecuteMessage()}},AxiomMessageManager.prototype._ExecuteMessage=function(iPreviousDelay){if(this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout),this.m_iMessageTimeout=0,this.m_oCurrentMessage&&!this.m_bPaused){var iPlayerTime=this.GetTime(),iDelay=Math.round(this.m_oCurrentMessage.Time-this.m_iStartTime-iPlayerTime);if(this.m_oPlayer||(iDelay=0),iDelay<=250||iPreviousDelay>0&&iPreviousDelay-iDelay<150&&this.m_bPendingStop||this.m_bMediaCompleted){var oCurrentMessage=this.m_oCurrentMessage;oCurrentMessage.SeekableIndex&&(this.m_iCurrentSeekableIndex=oCurrentMessage.SeekableIndex),this._MessageCall(oCurrentMessage),this._NextMessage()}else this.m_iMessageTimeout=setTimeout(this._ExecuteMessage.bind(this,iDelay),iDelay)}},AxiomMessageManager.prototype._MessageCall=function(oMessage){try{this.m_bLive||(oMessage instanceof AxiomScreenSharePublish?this.m_aLingeringMessages.push(oMessage):oMessage instanceof AxiomScreenShareUnPublish&&this.RemoveAssociatedMessage(oMessage,this.m_aLingeringMessages)),this.m_fnMessageCall&&this.m_fnMessageCall(oMessage)}catch(e){console.warn(e)}},AxiomMessageManager.prototype._onPlayerMetadataLoaded=function(){},AxiomMessageManager.prototype._onPlayerDataLoaded=function(){this.Resume()},AxiomMessageManager.prototype._onPlayerPlay=function(){this.m_bMediaCompleted=!1,this.m_bLive&&this.m_oPlayer&&this.m_oPlayer.getCurrentTime()<=1e3?setTimeout(this._onPlayerPlay.bind(this),50):this.Resume()},AxiomMessageManager.prototype._onPlayerPause=function(){this.Pause()},AxiomMessageManager.prototype._onPlayerSeeking=function(oData){this.m_bSeekInProgress=!0,this.m_iMessageTimeout&&clearTimeout(this.m_iMessageTimeout)},AxiomMessageManager.prototype._onPlayerSeeked=function(oData){this.m_bSeekInProgress=!1,!this.m_bLive&&oData.SeekTime>-1&&this.GoToMessageByTime(oData.SeekTime)},AxiomMessageManager.prototype._onPlayerComplete=function(oData){this.m_bMediaCompleted||(this.m_bMediaCompleted=!0,this.m_bPaused&&this.Resume())};